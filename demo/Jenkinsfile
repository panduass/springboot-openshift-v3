pipeline {
    agent any

    environment {
        // Informasi Docker
        DOCKER_IMAGE = "panduass/springboot-openshift-demo"
        DOCKER_CREDENTIALS_ID = "docker-hub"
        
        // Informasi GitHub
        GITHUB_REPO = "https://github.com/panduass/springboot-openshift-v3/"
        GITHUB_BRANCH = "main" // Atau 'master' tergantung repo Anda

        // Informasi OpenShift
        OPENSHIFT_SERVER = "https://api.rm1.0a51.p1.openshiftapps.com:6443"
        OPENSHIFT_PROJECT = "panduass-dev"
        OPENSHIFT_CREDENTIALS_ID = "openshift-v3"
        OC_APP_NAME = "springboot-openshift-demo"
    }

    stages {
        stage('Checkout') {
            steps {
                echo 'Cloning from GitHub...'
                git url: "${env.GITHUB_REPO}", branch: "${env.GITHUB_BRANCH}"
            }
        }

        stage('Build & Package') {
            steps {
                echo 'Building and packaging with Maven...'
                // Asumsi pom.xml ada di root directory
                sh 'mvn clean package -DskipTests'
            }
        }

        stage('Build Docker Image') {
            steps {
                script {
                    env.DOCKER_TAG = "v${env.BUILD_NUMBER}"
                    echo "Building Docker image: ${DOCKER_IMAGE}:${env.DOCKER_TAG}"
                    // Asumsi Dockerfile ada di root directory
                    docker.build("${DOCKER_IMAGE}:${env.DOCKER_TAG}")
                }
            }
        }

        stage('Push Docker Image') {
            steps {
                script {
                    echo "Pushing Docker image to Docker Hub"
                    docker.withRegistry('', "${DOCKER_CREDENTIALS_ID}") {
                        docker.image("${DOCKER_IMAGE}:${env.DOCKER_TAG}").push()
                    }
                }
            }
        }

        stage('Deploy to OpenShift') {
            steps {
                script {
                    withCredentials([string(credentialsId: "${OPENSHIFT_CREDENTIALS_ID}", variable: 'OC_TOKEN')]) {
                        echo "Logging into OpenShift..."
                        sh "oc login --token=${OC_TOKEN} --server=${OPENSHIFT_SERVER} --insecure-skip-tls-verify=true"
                        sh "oc project ${OPENSHIFT_PROJECT}"

                        echo "Checking for existing deployment..."
                        // Cek apakah DeploymentConfig sudah ada, jika belum, buat baru
                        def deploymentExists = sh(script: "oc get dc ${OC_APP_NAME} > /dev/null 2>&1 || [ \$? -eq 1 ]", returnStatus: true) == 0
                        if (deploymentExists) {
                            echo "DeploymentConfig ${OC_APP_NAME} exists, updating image..."
                            sh "oc set image dc/${OC_APP_NAME} ${OC_APP_NAME}=${DOCKER_IMAGE}:${env.DOCKER_TAG}"
                        } else {
                            echo "DeploymentConfig ${OC_APP_NAME} not found, creating new application..."
                            sh "oc new-app --image=${DOCKER_IMAGE}:${env.DOCKER_TAG} --name=${OC_APP_NAME}"
                            sh "oc expose service ${OC_APP_NAME} --port=8080"
                            sh "oc expose route ${OC_APP_NAME}"
                        }
                    }
                }
            }
        }
    }

    post {
        success {
            echo "CI/CD Pipeline finished successfully. Application is deployed!"
        }
        failure {
            echo "CI/CD Pipeline failed. Check the logs for details."
        }
    }
}